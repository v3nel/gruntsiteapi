name: Sync README to other repos (preserve header)

on:
  push:
    branches: [ 'main' ]

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Replace the example entries below with your actual target repos (owner/repo)
        repo: [ 'owner1/repo-a', 'owner2/repo-b' ]
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Show context
        run: |
          echo "Source repo: $GITHUB_REPOSITORY"
          echo "Target repo: ${{ matrix.repo }}"

      - name: Sync README (preserve first 3 lines)
        env:
          PAT: ${{ secrets.PERSONAL_TOKEN }} # add this secret in repository settings
          TARGET_REPO: ${{ matrix.repo }}
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "actions@github.com"
          RUN_ID: ${{ github.run_id }}
          SOURCE_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          echo "Cloning target repo: ${TARGET_REPO}"
          TARGET_DIR="target_repo"
          rm -rf "${TARGET_DIR}"
          git clone --depth=1 "https://x-access-token:${PAT}@github.com/${TARGET_REPO}.git" "${TARGET_DIR}" || (echo "Failed to clone ${TARGET_REPO}" && exit 1)

          SRC_README="README.md"
          if [ ! -f "${SRC_README}" ]; then
            echo "Source README not found at ${SRC_README}" && exit 1
          fi

          TARGET_README="${TARGET_DIR}/README.md"
          # If target has no README, copy full README
          if [ ! -f "${TARGET_README}" ]; then
            echo "Target README not found, copying full README"
            cp "${SRC_README}" "${TARGET_README}"
          else
            # Preserve first 3 lines of target README, append source from line 4 onward
            echo "Merging: preserving first 3 lines of target README"
            head -n 3 "${TARGET_README}" > "${TARGET_DIR}/README_preserved_header.tmp"
            tail -n +4 "${SRC_README}" > "${TARGET_DIR}/README_new_body.tmp" || true
            # If source README has <4 lines, README_new_body.tmp may be empty; in that case we keep header only
            cat "${TARGET_DIR}/README_preserved_header.tmp" "${TARGET_DIR}/README_new_body.tmp" > "${TARGET_README}.tmp"
            mv "${TARGET_README}.tmp" "${TARGET_README}"
            rm -f "${TARGET_DIR}/README_preserved_header.tmp" "${TARGET_DIR}/README_new_body.tmp" || true
          fi

          cd "${TARGET_DIR}"
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"

          if git status --porcelain | grep -q .; then
            git add README.md
            git commit -m "chore: sync README from ${SOURCE_REPO} (run ${RUN_ID})"

            echo "Attempting to push directly to main on ${TARGET_REPO}"
            set +e
            git push origin HEAD:main
            PUSH_EXIT=$?
            set -e

            if [ "$PUSH_EXIT" -eq 0 ]; then
              echo "Pushed README to ${TARGET_REPO}"
            else
              echo "Direct push failed (branch may be protected). Creating branch and PR."
              BRANCH_NAME="sync-readme-${RUN_ID}"
              git rev-parse --abbrev-ref HEAD || true
              git checkout -b "${BRANCH_NAME}"
              git push origin "${BRANCH_NAME}"

              # Create PR using REST API
              API_URL="https://api.github.com/repos/${TARGET_REPO}/pulls"
              PR_TITLE="chore: sync README from ${SOURCE_REPO}"
              PR_BODY="This PR syncs the README from ${SOURCE_REPO} (workflow run ${RUN_ID})."
              DATA=$(jq -n --arg title "$PR_TITLE" --arg head "$BRANCH_NAME" --arg base "main" --arg body "$PR_BODY" '{title:$title,head:$head,base:$base,body:$body}')
              curl -s -H "Authorization: token ${PAT}" -X POST -d "$DATA" "$API_URL" || true
              echo "PR created (or attempted) for ${TARGET_REPO}"
            fi
          else
            echo "No changes to README for ${TARGET_REPO}"
          fi

          echo "Cleanup"
          cd ..
          rm -rf "${TARGET_DIR}"

      - name: Done
        run: echo "Sync step finished"
